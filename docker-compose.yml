services:
  bot:
    build: .
    image: gridbot:latest
    container_name: gridbot
    restart: unless-stopped
    env_file: /srv/secret-envs/gridbot.env
    command: python grid_trading_bot.py # ⬅ ejecuta el trader
    environment:
      DATA_DIR: /data
    volumes:
      - data:/data
    networks:
      - web

  dashboard:
    image: gridbot:latest # reutiliza la MISMA imagen
    depends_on: [bot]
    restart: unless-stopped
    env_file: /srv/secret-envs/gridbot.env
    command: >
      bash -c "streamlit run dashboard.py
               --server.port 8501
               --server.address 0.0.0.0"
    environment:
      DATA_DIR: /data
    volumes:
      - data:/data
    labels: # Traefik 🔽
      traefik.enable: true

      # ─────────────── Routers HTTPS ───────────────
      traefik.http.routers.gridbot.rule: Host(`gridbot.mollitiam.cl`)
      traefik.http.routers.gridbot.entrypoints: websecure
      traefik.http.routers.gridbot.tls.certresolver: le
      traefik.http.routers.gridbot.service: gridbot
      traefik.http.routers.gridbot.middlewares: gridbot@docker # ⬅️  añadimos el SPA

      traefik.http.routers.gridbot2.rule: Host(`www.gridbot.mollitiam.cl`)
      traefik.http.routers.gridbot2.entrypoints: websecure
      traefik.http.routers.gridbot2.tls.certresolver: le
      traefik.http.routers.gridbot2.service: gridbot
      traefik.http.routers.gridbot2.middlewares: gridbot@docker # ⬅️  idem www

      # ─────────────── Routers HTTP (301 a HTTPS) ───────────────
      traefik.http.routers.gridbot-http.rule: Host(`gridbot.mollitiam.cl`)
      traefik.http.routers.gridbot-http.entrypoints: web
      traefik.http.routers.gridbot-http.middlewares: gridbot-redirect

      traefik.http.routers.gridbot2-http.rule: Host(`www.gridbot.mollitiam.cl`)
      traefik.http.routers.gridbot2-http.entrypoints: web
      traefik.http.routers.gridbot2-http.middlewares: gridbot-redirect

      # ─────────────── Middlewares ───────────────
      ## redirección 80 → 443
      traefik.http.middlewares.gridbot-redirect.redirectscheme.scheme: https
      traefik.http.middlewares.gridbot-redirect.redirectscheme.permanent: "true"

      # ─────────────── Servicio ───────────────
      traefik.http.services.gridbot.loadbalancer.server.port: "8501"

      # etiqueta-dummy para que Compose re-cree la imagen en cada push
      traefik.deploy.version: "${GITHUB_SHA:-local}"

    networks:
      - web

volumes:
  data:

networks:
  web:
    external: true # es la misma red que usa Traefik
    name: traefik_default
